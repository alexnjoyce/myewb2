{% extends "confcomm/base.html" %}


{% block body %}
<div id="hash-nav">
    <a href="#/">Home</a>
    <a href="#/profile/">Profile</a>
    <a href="#/profile/edit/">Edit Profile</a>
</div>
<div id="all" style="height:800px;">
<div id="left" style="float: left; width: 65%;">
    <div id="main-view"></div>
    <div id="profile"></div>
    <div id="profile-form-container"></div>
</div>
<div id="right" style="float:right; width: 35%;">
    <div id="profile-list"></div>
</div>
</div>
{% endblock body %}

{% block extra_body %}
<script type="text/javascript" src="{{ STATIC_URL }}js/json2.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.ba-hashchange.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/underscore-min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/backbone-min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/backbone.spwa.js"></script>

{# templates #}
<script id="profile-template" type="x-ejs">
<h2>Profile for <%= model.get('member_profile').name %></h2>
<img src="<%= model.get('avatar_url') %> />
<p><strong>Conference Question:</strong> <%= model.get('conference_question') %></p>
<p><strong>Conference Goals:</strong> <%= model.get('conference_goals') %></p>
<p><strong>What I am Doing Now:</strong> <%= model.get('what_now') %></p>
<p><strong>I am registered for conference:</strong> <%= model.get('registered') %></p>
</script>

<script id="profile-list-template" type="x-ejs">
<h2>Profiles</h2>
<ul>
<% collection.each(function(p){ %>
    <li><a href="<%= p.hash() %>"><%= p.get('member_profile').name %></a></li>
<% }); %>
</ul>
</script>

<script id="main-template" type="x-ejs">
<p><strong>Welcome <%= model.get('member_profile').name %>!</strong></p>
<p>The dashboard would go here.</p>
</script>

<script id="profile-form-template" type="x-ejs">
<h2>Edit your profile below</h2>
<form id="profile-form" onsubmit="return false;">
<p><strong>Conference Question:</strong> <textarea class="profile-input" name="conference_question"><%= model.get('conference_question') %></textarea></p>
<p><strong>Conference Goals:</strong> <textarea class="profile-input" name="conference_goals"><%= model.get('conference_goals') %></textarea></p>
<p><strong>What Now:</strong> <textarea class="profile-input" name="what_now"><%= model.get('what_now') %></textarea></p>
    <input id="update-profile" value="Update" type="submit" />
</form>
</script>

<script type="text/javascript">
;(function() {
  // Helper function to get a URL from a Model or Collection as a property
  // or as a function.
  var getUrl = function(object) {
    if (!(object && object.url)) throw new Error("A 'url' property or function must be specified");
    return _.isFunction(object.url) ? object.url() : object.url;
  };
  // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
  var methodMap = {
    'create': 'POST',
    'update': 'PUT',
    'delete': 'DELETE',
    'read'  : 'GET'
  };
  Backbone.sync = function(method, model, success, error) {
    var sendModel = method === 'create' || method === 'update';
    // changing data to remove the {'model':} namespace on the data.
    var data = sendModel ? JSON.stringify(model) : {};
    var type = methodMap[method];
    if (Backbone.emulateHttp && (type === 'PUT' || type === 'DELETE')) {
      data._method = type;
      type = 'POST';
    }
    $.ajax({
      url       : getUrl(model),
      type      : type,
      data      : data,
      dataType  : 'json',
      success   : success,
      error     : error,
      contentType : 'application/json'
    });
  };
  })();
</script>
<script type="text/javascript">
;(function() {
    var current_username;
    var current_profile;
    /* SERVER ROUTES */
    var routes = {
        profile_base: "{% url confcomm_profile_api_base %}",
        profiles_base: "{% url confcomm_profile_api_profiles %}"
    }
    /* MODELS */
    var ConferenceProfile = Backbone.Model.extend({
        initialize: function() {
            var self = this;
            if (!self.id) self.id = self.get('username');
        },
        url: function() {
            var self = this;
            return routes.profile_base + self.id + '/';
        },
        hash: function() {
            var self = this;
            return '#/profile/?id=' + self.id;
        }
    });
    /* COLLECTIONS */
    var ProfileStore = Backbone.Collection.extend({
        model: ConferenceProfile
    });
    /* VIEWS */
    var MainView = Backbone.SPWA.View.extend({
        el: $('#main-view'),
        template: $('#main-template').html(),
        render: function() {
            var self = this;
            $(self.el).html(_.template(self.template, {model: current_profile}));
        }
    });
    var ProfileView = Backbone.SPWA.View.extend({
        el: $('#profile'),
        template: $('#profile-template').html(),
        render: function() {
            var self = this;
            $(self.el).html(_.template(self.template, {model:self.model}));
            // self.handleEvents();
        }
    });
    var ProfileFormView = Backbone.SPWA.View.extend({
        el: $('#profile-form-container'),
        template: $('#profile-form-template').html(),
        events: {'submit #profile-form': 'update_profile'},
        update_profile: function() {
            var self = this;
            var inputs = $('#profile-form').find('.profile-input');
            var data = {}
            _.each(inputs, function(i) {
                if (i.name) data[i.name] = i.value;
            });
            // self.model.set(data);
            self.model.save(data, {success: function(){location.hash='/profile/'}});
            return false;
        },
        render: function() {
            var self = this;
            $(self.el).html(_.template(self.template, {model:self.model}));
        }});
    var ProfilesView = Backbone.SPWA.View.extend({
        el: $('#profile-list'),
        template: $('#profile-list-template').html(),
        render: function() {
            var self = this;
            console.log('in profile view.');
            console.log(self.collection);
            $(self.el).html(_.template(self.template, {collection:self.collection}));
        }});
    /* CONTROLLER */
    var Controller = Backbone.SPWA.Controller.extend({
        routes: {
            '/': 'main',
            '/profile/': 'profile',
            '/profile/edit/': 'edit_profile'
        },
        views: {
            'Profile': ProfileView,
            'ProfileForm': ProfileFormView,
            'Main': MainView
        },
        main: function(args) {
            var self = this;
            self.hideAll();
            var view = self.getView('Main');
            view.show();
        },
        profile: function(args) {
            var self = this;
            self.hideAll();
            var view = self.getView('Profile');
            var id = args.id ? args.id : current_username;
            view.model = profiles.get(id);
            if (!view.model) {
                var profile_to_get = new ConferenceProfile({
                    id: id
                });
                profile_to_get.fetch({success: function(){
                    profiles.add(profile_to_get);
                    view.model = profile_to_get;
                    view.show();
                    }
                });
            }
            else {
                view.show();
            }
        },
        edit_profile: function(args) {
            var self = this;
            self.hideAll();
            var view = self.getView('ProfileForm');
            var id = current_username;
            view.model = profiles.get(id);
            view.show();
        }
    });

    app = new Controller();

    /* GO TIME */
    $(function() {
        current_username = '{{ username }}';
        current_profile = new ConferenceProfile({
            id: current_username
        });
        profiles = new ProfileStore();
        all_profiles = new ProfileStore(); // 
        all_profiles.url = routes.profiles_base;
        all_profiles.fetch({success: function() {
            console.log('success');
            console.log(all_profiles);
            var v = new ProfilesView();
            v.collection = all_profiles;
            v.render();
        }});
        current_profile.fetch({success: function(){
            profiles.add(current_profile);
            if (!location.hash) {
                location.hash = '/';
            }
            else {
                $(window).hashchange();
            }
        }});
    });
})();
</script>
{% endblock extra_body %}
